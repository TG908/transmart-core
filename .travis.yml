dist: trusty
sudo: required

language: groovy

jdk:
  - oraclejdk8
php:
  - 5.6
env:
  global:
    - TERM=dumb
    - PGCONFIG_PARAMS="PG_CONFIG=/usr/lib/postgresql/9.6/bin/pg_config"
  matrix:
    - DIR=transmart-core-api; TEST=check
    - DIR=transmart-core-db-tests; PREPARE=assemble; TEST=check
    - DIR=transmart-rest-api; TEST=check
    - DIR=transmart-core-db; INSTALL=":transmart-data:createVars :transmart-data:setupPostgresTest"; TEST=check
    - DIR=transmart-api-server; TEST=check
    - DIR=transmart-copy; INSTALL=":transmart-data:createVars :transmart-data:setupPostgres"; PREPARE=shadowJar; TEST=check
    - DIR=transmart-schemas; PREPARE=assemble; TEST=check
    - DIR=.; TEST="publishToMavenLocal"

addons:
  postgresql: 9.6

before_cache:
  - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -rf $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches
    - $HOME/.gradle/wrapper
    - $HOME/.m2
    - $HOME/pg

before_install:
  - gradle wrapper
  - GRADLE_SCRIPT="$(pwd)/gradlew"
  - $GRADLE_SCRIPT --version
  - groovy --version
  - sudo chmod a+rX $HOME
# We don't currently use these sources, but they can be re-enabled if necessary
#  - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv 3375DA21
#  - echo deb http://apt.thehyve.net/internal/ trusty main | sudo tee /etc/apt/sources.list.d/hyve_internal.list
#  - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E5267A6C
#  - echo deb http://ppa.launchpad.net/ondrej/php/ubuntu trusty main  | sudo tee /etc/apt/sources.list.d/ondrej_php.list
  - sudo apt-get -qq update
  - sudo apt-get install -y tk-dev html2text gnupg2
  - gpg2 --version
  - php --version
  - ([ -z "$PREINSTALL" ] && echo "Skipping preinstall.") || (echo $PREINSTALL; $PREINSTALL)
  - PWD=`pwd`
  - echo $PWD

install:
  - pushd "$DIR"
  - ([ -z "$INSTALL" ] && echo "Skipping install.") || (echo $INSTALL; $GRADLE_SCRIPT $INSTALL)
  - popd

before_script:
  - pushd "$DIR"
  - ([ -z "$PREPARE" ] && echo "Skipping prepare.") || (echo $PREPARE; $GRADLE_SCRIPT $PREPARE)
  - popd

script:
  - pushd "$DIR"
  - ([ -z "$TEST" ] && echo "Skipping test.") || (echo $TEST; $GRADLE_SCRIPT $TEST)
  - popd

after_success:
  - echo "Writing summary..."
  - ([ -d "$DIR/build/reports/tests" ]) && html2text $DIR/build/reports/tests/index.html

after_failure:
  - echo "Writing error logs..."
  - for f in "$DIR"/hs_err_*.log; do echo "$f"; cat "$f"; done
  - echo "Writing reports..."
  - html2text "$DIR/build/reports/tests/index.html"
  - for f in "$DIR"/build/reports/tests/classes/*.html; do echo "$f"; html2text "$f"; done
  - ([ -d "$DIR/build/reports/tests/functional" ]) && (html2text "$DIR/build/reports/tests/functional/index.html")
  - ([ -d "$DIR/build/reports/tests/functional" ]) && (for f in "$DIR"/build/reports/tests/functional/classes/*.html; do echo "$f"; html2text "$f"; done)
